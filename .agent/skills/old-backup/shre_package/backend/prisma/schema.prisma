// Prisma schema for shre platform
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  username  String   @unique @db.VarChar(255)
  email     String   @unique @db.VarChar(255)
  password  String   @db.VarChar(255)
  role      UserRole @default(USER)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  documents Document[]
  refreshTokens RefreshToken[]
  employee Employee?

  @@map("users")
  @@index([email])
  @@index([username])
}

model Document {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  name      String   @db.VarChar(255)
  content   Bytes    // BYTEA in PostgreSQL
  mimeType  String?  @map("mime_type") @db.VarChar(100)
  size      Int?     // File size in bytes
  version   Int      @default(1)
  s3Key     String?  @map("s3_key") @db.VarChar(500) // AWS S3 object key
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  employeeDocuments EmployeeDocument[]

  @@map("documents")
  @@index([userId])
  @@index([name])
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
  @@index([userId])
  @@index([token])
}

enum EmploymentStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  TERMINATED
}

enum Department {
  ENGINEERING
  HR
  FINANCE
  MARKETING
  SALES
  OPERATIONS
  IT
  LEGAL
  ADMIN
}

model Employee {
  id             String           @id @default(uuid()) @db.Uuid
  userId         String?          @unique @map("user_id") @db.Uuid // Optional link to User account
  
  // Personal Information
  firstName      String           @map("first_name") @db.VarChar(100)
  lastName       String           @map("last_name") @db.VarChar(100)
  email          String           @unique @db.VarChar(255)
  phone          String?          @db.VarChar(20)
  dateOfBirth    DateTime?        @map("date_of_birth") @db.Date
  address        String?          @db.Text
  
  // Employment Information
  employeeId     String           @unique @map("employee_id") @db.VarChar(50)
  department     Department
  position       String           @db.VarChar(100)
  status         EmploymentStatus @default(ACTIVE)
  hireDate       DateTime         @map("hire_date") @db.Date
  terminationDate DateTime?       @map("termination_date") @db.Date
  
  // Compensation (encrypted in application layer)
  salary         Decimal?         @db.Decimal(10, 2)
  currency       String?          @default("USD") @db.VarChar(3)
  
  // Manager/Reporting
  managerId      String?          @map("manager_id") @db.Uuid
  
  // Metadata
  notes          String?          @db.Text
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  
  // Relations
  user           User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  manager        Employee?        @relation("EmployeeHierarchy", fields: [managerId], references: [id])
  subordinates   Employee[]       @relation("EmployeeHierarchy")
  documents      EmployeeDocument[]
  
  @@map("employees")
  @@index([email])
  @@index([employeeId])
  @@index([department])
  @@index([status])
  @@index([managerId])
}

model EmployeeDocument {
  id          String   @id @default(uuid()) @db.Uuid
  employeeId  String   @map("employee_id") @db.Uuid
  documentId  String   @map("document_id") @db.Uuid
  category    String   @db.VarChar(100) // e.g., "contract", "id_proof", "certificate"
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  
  // Relations
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  @@map("employee_documents")
  @@index([employeeId])
  @@index([documentId])
  @@index([category])
}
