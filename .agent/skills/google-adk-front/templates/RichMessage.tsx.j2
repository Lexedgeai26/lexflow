import React from 'react';
import ReactMarkdown from 'react-markdown';
import { Card, Table, Badge } from '@/components/ui'; // Standardized UI library

interface RichMessageProps {
  content: string;
  author?: string;
}

export const RichMessage: React.FC<RichMessageProps> = ({ content, author }) => {
  // Regex to detect JSON blocks
  const jsonMatch = content.match(/```json\n([\s\S]*?)\n```/);
  
  if (jsonMatch) {
    try {
      const data = JSON.parse(jsonMatch[1]);
      const textBefore = content.split('```json')[0];
      const textAfter = content.split('```')[2];

      return (
        <div className="space-y-4">
          <ReactMarkdown className="prose dark:prose-invert">{textBefore}</ReactMarkdown>
          <div className="bg-neutral-900 border border-neutral-700 rounded-2xl p-6 shadow-xl animate-in fade-in slide-in-from-bottom-2">
             <h4 className="text-sm font-bold text-blue-400 mb-3 uppercase tracking-wider">
               {author || 'Agent'} Structured Output
             </h4>
             <RenderStructuredData data={data} />
          </div>
          <ReactMarkdown className="prose dark:prose-invert">{textAfter}</ReactMarkdown>
        </div>
      );
    } catch (e) {
      console.error("Failed to parse agent JSON", e);
    }
  }

  return (
    <div className="prose dark:prose-invert max-w-none">
      <ReactMarkdown>{content}</ReactMarkdown>
    </div>
  );
};

const RenderStructuredData = ({ data }: { data: any }) => {
  if (Array.isArray(data)) {
    return (
      <div className="overflow-x-auto">
        <table className="w-full text-left text-sm">
          <thead>
            <tr className="border-b border-neutral-700">
              {Object.keys(data[0] || {}).map(k => <th key={k} className="py-2 px-3 font-semibold">{k}</th>)}
            </tr>
          </thead>
          <tbody>
            {data.map((item, i) => (
              <tr key={i} className="border-b border-neutral-800 hover:bg-neutral-800/50">
                {Object.values(item).map((v: any, j) => <td key={j} className="py-2 px-3">{String(v)}</td>)}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    );
  }
  return <pre className="text-xs font-mono text-neutral-400 overflow-auto">{JSON.stringify(data, null, 2)}</pre>;
};
